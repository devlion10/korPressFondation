<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_layout}">
<body>
<div layout:fragment="content">

    <div class="subpage_banner" style="background-image: url(/assets/images/top_visual.png)">
        <div class="ly_grid">
            <div class="banner_title_area">
                <h3 class="banner_title">로그인</h3>
            </div>
        </div>
    </div>

    <!-- CONTAINER -->
    <div class="container">
        <!-- CONTENT -->
        <div class="content">
            <div class="ly_grid">
                <div class="cont_title">비밀번호 변경하기</div>
                <div class="card" th:if="${param.userId != 'null' && param.userId[0] != 'null'}">
                    <div>
                        <div class="form_box">
                            <div class="input_box">
                                <label for="password">비밀번호<span class="essential">*</span></label>
                                <input type="password" name="password" id="password" class="common_input2" placeholder="비밀번호" >
                                <div class="guide_text"><span>※</span> 8자리 이상 25자리 이하 영문, 숫자, 특수문자 중 3가지 이상으로 조합</div>
                                <div class="guide_text"><span>※</span> 허용된 특수문자 : ~!@#$%^&*(){}[]&lt;&gt;?</div>
                            </div>

                            <div class="input_box">
                                <label for="password2">비밀번호 재확인<span class="essential">*</span></label>
                                <input type="password" name="password2" id="password2" class="common_input2" placeholder="비밀번호 재확인" >
                            </div>

                            <div class="btn_box">
                                <button type="button" class="btn_type1 btn_gray" onclick="location.href='/login/find?pw=true'">이전</button>
                                <button type="submit" class="btn_type1 btn_blue" onclick="change()">변경하기</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card" th:unless="${param.userId != 'null' && param.userId[0] != 'null'}">
                    <div>
                        <div class="text_box">
                            <p class="card_title">입력하신 정보로 가입된 정보가 없습니다.</p>
                        </div>
                        <div class="btn_box">
                            <a href="/login/find" class="btn_type1 btn_gray">아이디 찾기</a>
                            <a href="/user/join" class="btn_type1 btn_blue">회원가입</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="script">
        <script th:inline="javascript">
            /* <![CDATA[ */
            function onLoadSubmit(){
                console.log('error: ', [[ ${errorMessage} ]] )
                console.log('result: ', [[ ${result} ]] )
                console.log('param: ', [[ ${param} ]] )
            }

            let param = [[ ${param} ]];
            let CON = {};
            CON.userId = param.userId[0];

            function change() {
                if($('#password').val() || $('#password2').val()){
                    if($('#password').val() === $('#password2').val()){
                        if(!/^(?=.*[a-zA-Z])(?=.*[0-9]).{8,25}$/.test($('#password').val())){
                            alert('유효하지 않은 비밀번호입니다.');
                        } else {
                            // 비밀번호 변경 + 정보 수정 api
                            CON.password = $('#password').val();
                            $.ajax({ //jquery ajax
                                type: "PUT", //http method
                                url: "/api/user/change-password", //값을 가져올 경로
                                headers: {'Content-Type': 'application/json'},
                                dataType: "json", //html, xml, text, script, json, jsonp 등 다양하게 쓸 수 있음
                                data:JSON.stringify(CON),
                                success : function(res){
                                    alert('비밀번호 변경이 완료되었습니다.')
                                    window.location.replace("/login");
                                },
                                error : function(e){
                                    alert("비밀번호 변경 중 오류가 발생했습니다.")
                                }
                            });
                        }
                    } else {
                        alert('입력한 비밀번호가 일치하지 않습니다.')
                    }
                } else {
                    alert('비밀번호를 입력해주세요.')
                }
            }
            /* ]]> */
        </script>
    </th:block>

</div>
</body>
</html>
