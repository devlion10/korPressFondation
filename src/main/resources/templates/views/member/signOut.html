<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_layout}">
<body>
<div layout:fragment="content">

    <div class="subpage_banner" style="background-image: url(../assets/images/top_visual.png)">
        <div class="ly_grid">
            <div class="banner_title_area">
                <h3 class="banner_title">회원탈퇴</h3>
            </div>
        </div>
    </div>

    <!-- CONTAINER -->
    <div class="container">
        <!-- CONTENT -->
        <div class="content">
            <div class="ly_grid">
                <div class="card">
                    <div>
                        <img th:src="@{/assets/images/subpage_member/card_icon.png}" alt="" >
                        <div class="text_box">
                            <p class="card_title">회원탈퇴 신청에 앞서 아래의 사항을 반드시 <span>확인</span>하시기 바랍니다.</p>
                            <p class="card_text">회원탈퇴를 하실 경우, <span>회원정보가 삭제되며 복구가 불가능</span>합니다.</p>
                        </div>
                        <div class="chk_box">
                            <input id="sign_out_agree" type="checkbox" >
                            <label for="sign_out_agree">
                                <span></span>
                                위 내용을 확인하였으며 탈퇴를 진행합니다.
                            </label>
                        </div>
                        <div class="line"></div>
                        <div class="form_box">
                            <div class="title">본인확인을 위해 아이디와 비밀번호를 입력해주세요.</div>
                            <label for="floatingInput">아이디</label>
                            <input type="text" name="username" id="floatingInput" class="common_input2" placeholder="아이디" data-not_null="true" data-alert_name="아이디" >
                            <label for="floatingPassword">비밀번호</label>
                            <input type="password" name="password" id="floatingPassword" class="common_input2" placeholder="비밀번호" data-not_null="true" data-alert_name="비밀번호" >
                            <button type="submit" class="btn_type1 btn_blue mt-3" onclick="signOutChk()">회원탈퇴</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="script">
        <script th:inline="javascript">
            /* <![CDATA[ */
            function signOut(params){
                if (confirm("정말로 탈퇴하시겠습니까?")) {
                    $.ajax({
                        type: "put",
                        headers: {'Content-Type' : 'application/json'},
                        url: `/api/user/withdrawal/${params.userId}`,
                        data: JSON.stringify(params),
                        dataType: "json",
                        success: function (data){
                            alert("회원 탈퇴가 완료되었습니다.");
                            location.replace('/logout');
                        },
                        error: function (e){
                            alert(e.responseJSON.resultMessage);
                        }
                    })
                }
            }

            function signOutChk() {
                if ($('#sign_out_agree').is(':checked')) { //탈퇴 동의 체크박스 true일 때
                    let params = getFormData();
                    if (nullCheck()) {
                        if ($('#floatingInput').val() == params.userId) {
                            params.password = $('#floatingPassword').val();
                            signOut(params);
                        } else {
                            alert('잘못된 아이디입니다.')
                        }
                    }
                } else {
                    alert('탈퇴 동의가 필요합니다.')
                }
            }

            function getFormData() {
                const auth = [[ ${#authentication} ]];
                let params = {};
                params.approFlag = auth.principal.approFlag;
                params.attachFilePath = '';
                params.birthDay = auth.principal.birthday;
                params.certValue = '';
                params.ci = '';
                params.department = '';
                params.di = '';
                params.email = auth.principal.email;
                params.gender = auth.principal.gender;
                params.isEmailAgree = true;
                params.isLock = false;
                params.isSmsAgree = true;
                params.lockCount = 0;
                params.lockDateTime = '';
                params.mediaCode = '';
                params.migrationFlag = '';
                params.organizationCode = auth.principal.organizationCode == null ? '' : auth.principal.organizationCode;
                params.parentBirthDay = '';
                params.parentGender = '';
                params.parentName = '';
                params.password = '';
                params.passwordChangeDate = '';
                params.personalNeisNo = '';
                params.phone = auth.principal.phone;
                params.position = '';
                params.rank = '';
                params.roleGroup = auth.principal.roleGroup;
                params.state = '';
                params.userId = auth.principal.userId;
                params.userName = auth.principal.username;
                params.withDrawDate = '';
                return params;
            }

            function onLoadSubmit() { console.log('commonCode: ', [[ ${commonCode} ]] ) }
            /* ]]> */
        </script>
    </th:block>
</div>
</body>
</html>
