<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default_layout}">
<body>
<div layout:fragment="content">

    <div class="subpage_banner" th:style="'background-image: url(' + @{/assets/images/top_visual5.png} + ')'">
        <div class="ly_grid">
            <div class="banner_title_area">
                <h3 class="banner_title">참여/소통</h3>
            </div>
        </div>
    </div>
    <div class="navigation"></div>

    <!-- CONTAINER -->
    <div class="container">
        <!-- CONTENT -->
        <div class="content">
            <div class="ly_grid">
                <div class="bl_title">
                    <div class="bl_title_left">
                        <div class="page_title">
                            <span>교육 주제 제안</span>
                            <span id="type__"></span>
                        </div>
                    </div>
                </div>

                <!-- BOARD : LIST2 -->
                <div class="bl_board2">
                    <ul th:if="${content != null && content.size > 0}">
                        <li th:each="item,stat : ${content}">
                            <div class="bl_board2_head">
                                <div class="bl_board2_name">
                                    <span th:text="${item.suggestUser}"></span>
                                    (<span th:text="${item.registUserId}"></span>)
                                </div>
                                <div class="bl_board2_btns" th:if="${#authentication.principal != 'anonymousUser'}">
                                    <button class="btn_type3 btn_del"
                                            th:if="${item.registUserId == #authentication.principal.userId}"
                                            th:onclick="deleteItem( [[${stat.index}]] )"
                                    >삭제</button>
                                    <button class="btn_type3 btn_modify"
                                            th:if="${item.registUserId == #authentication.principal.userId}"
                                            data-control="modal" data-handler="pop"
                                            th:onclick="selectItem( [[${stat.index}]] )"
                                    >수정</button>
                                </div>
                                <div class="bl_board2_date" th:text="${item.createDateTime}"></div>
                            </div>
                            <div class="bl_board2_body">
                                <div th:if="${#authentication.principal != 'anonymousUser'}">
                                    <i class="el_ico" th:if="${item.isSecurity}">
                                        <img th:src="@{/assets/images/icons/lock.png}" alt="">
                                    </i>
                                    <span class="suggest_text" th:text="${item.contents}"
                                          th:unless="${(item.isSecurity) && (item.registUserId != #authentication.principal.userId) && (#authentication.authorities[0].authority != 'SUPER')}"
                                    ></span>
                                    <span class="text-black-50"
                                        th:if="${(item.isSecurity) && (item.registUserId != #authentication.principal.userId) && (#authentication.authorities[0].authority != 'SUPER')}"
                                    >비밀글입니다.</span>
                                </div>
                                <div th:unless="${#authentication.principal != 'anonymousUser'}">
                                    <i class="el_ico" th:if="${item.isSecurity}">
                                        <img th:src="@{/assets/images/icons/lock.png}" alt="">
                                    </i>
                                    <span class="suggest_text" th:unless="${(item.isSecurity)}" th:text="${item.contents}"></span>
                                    <span class="text-black-50" th:if="${(item.isSecurity)}">비밀글입니다.</span>
                                </div>
                            </div>
                            <div class="bl_board2_reply" th:if="${item.commentUser != null}"> <!-- 답글 영역 -->
                                <span class="answer_icon"></span>
                                <div th:if="${#authentication.principal != 'anonymousUser'}">
                                    <div th:unless="${(item.commentSecurity) && (item.registUserId != #authentication.principal.userId) && (#authentication.authorities[0].authority != 'SUPER')}">
                                        <div class="bl_board2_head">
                                            <div class="bl_board2_name">
                                                <span th:text="${item.commentUser}">홍길동</span>
                                                (<span th:text="${item.commentUserId}">honggildong1234</span>)
                                            </div>
                                            <div class="bl_board2_date" th:text="${item.updateDateTime}">2022.08.24</div>
                                        </div>
                                        <div class="bl_board2_body suggest_text" th:text="${item.comment}">답글입니다.</div>
                                    </div>
                                    <div th:if="${(item.commentSecurity) && (item.registUserId != #authentication.principal.userId) && (#authentication.authorities[0].authority != 'SUPER')}">
                                        <div class="bl_board2_body text-black-50">
                                            <i class="el_ico">
                                                <img th:src="@{/assets/images/icons/lock.png}" alt="">
                                            </i>
                                            <span>비밀 답글입니다.</span>
                                        </div>
                                    </div>
                                </div>
                                <div th:unless="${#authentication.principal != 'anonymousUser'}">
                                    <div class="hp_w100p">
                                        <div class="bl_board2_body">
                                            로그인 후 확인 가능합니다.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="bl_paginate"></div>

                <!-- BOARD : WRITE2 -->
                <div class="bl_boardWrite2" th:if="${#authentication.principal != 'anonymousUser'}">
                    <div class="bl_boardWrite2_head">
                        <div class="bl_boardWrite2_info">
                            <div class="bl_boardWrite2_name">
                                <span th:text="${#authentication.principal.name}"></span>
                                (<span th:text="${#authentication.principal.userId}"></span>)
                            </div>
                        </div>

                        <div class="bl_boardWrite2_date">
                            <div class="chk_box text_sm">
                                <input id="isSecurity" type="checkbox">
                                <label for="isSecurity">
                                    <span></span>
                                    비밀글
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="bl_boardWrite2_body">
                        <label for="contents" class="hidden_label">글 내용</label>
                        <textarea class="common_input" name="contents" id="contents" cols="30" rows="3"></textarea>
                    </div>

                    <!-- GRID : BUTTON -->
                    <div class="bl_gridBtns">
                        <div class="bl_gridBtns_md">
                            <a class="btn_type1 btn_blue" onclick="create()">등록하기</a>
                        </div>
                    </div>
                </div>

                <div class="bl_boardWrite2" style="text-align: center" th:if="${#authentication.principal == 'anonymousUser'}">
                    <span>로그인 후 작성 가능합니다.</span>
                </div>
            </div>
        </div>

        <!-- POPUP : -->
        <div class="pop_wrapper ui-modal" id="pop">
            <div class="pop_wrap pop_secondary hp_mw500">
                <div class="pop_cont">
                    <div class="bl_boardWrite2_date" style="margin-bottom: 10px; display: flex; justify-content: flex-end">
                        <div class="chk_box text_sm">
                            <input id="popIsSecurity" type="checkbox">
                            <label for="popIsSecurity">
                                <span></span>
                                비밀글
                            </label>
                        </div>
                    </div>
                    <div>
                        <label for="popCont" class="hidden_label">글 내용</label>
                        <textarea class="common_input" name="popCont" id="popCont" cols="30" rows="3"></textarea>
                    </div>
                    <div class="bl_gridBtns">
                        <div class="bl_gridBtns_md">
                            <div class="btn btnDefault pop-close" onclick="update()">수정</div>
                        </div>
                    </div>
                </div>
                <button type="button" class="pop_close pop-close">닫기</button>
            </div>
        </div>
    </div>

    <th:block layout:fragment="script">
        <script th:inline="javascript">
            function create(){
                let params = getFormData();
                params.commentSecurity = false;
                if(params.contents && params.contents!="" && confirm("정말로 등록하시겠습니까?")){
                    $.ajax({ //jquery ajax
                        type: "post", //http method
                        url: "/api/communication/edu-suggestion/create", //값을 가져올 경로
                        headers: {'Content-Type': 'application/json'},
                        data: JSON.stringify(params),
                        dataType: "json",
                        success: function(data) {
                            alert("등록되었습니다.");
                            window.location.reload()
                        },
                        error: function(e) {
                            console.log(e);
                            if(e && e.responseJSON && e.responseJSON.resultMessage){
                                alert(e.responseJSON.resultMessage);
                            }else{
                                alert('교육 제안을 등록하는 과정에서 오류가 발생하였습니다.');
                            }
                        }

                    })
                }
            }
            /* <![CDATA[ */
            function getFormData(){
                let params ={};
                params.isSecurity = $("#isSecurity").is(":checked");
                params.comment = "";
                params.contents=$("#contents").val();
                params.sequenceNo = 0
                let text = $("#type__").text();
                if(text == '(언론인)'){
                    params.suggestionType =1
                }else{
                    params.suggestionType =2
                }
                params.viewCount = 1
                return params;
            }
            let target;
            function selectItem(idx){
                const CONT = [[ ${content} ]];
                $('#popCont').text(CONT[idx].contents)
                if(CONT[idx].isSecurity){
                    $('input:checkbox[name="네임"]').prop('checked',true);
                } else {
                    $('input:checkbox[name="네임"]').prop('checked',false);
                }
                target = CONT[idx];
            }
            function deleteItem(idx){
                const CONT = [[ ${content} ]];

                if (confirm("정말 삭제하시겠습니까?")) {
                    $.ajax({
                        type: "delete", //http method
                        url: "/api/communication/edu-suggestion/delete/"+CONT[idx].sequenceNo, //값을 가져올 경로
                        headers: {'Content-Type': 'application/json'},
                        data: JSON.stringify(CONT[idx]),
                        dataType: "json",
                        success: function(data) {
                            alert("삭제가 완료되었습니다.")
                            location.reload();
                        },
                        error: function(e) {
                            console.log(e);
                            if(e && e.responseJSON && e.responseJSON.resultMessage){
                                alert(e.responseJSON.resultMessage);
                            }else{
                                alert('삭제 중 오류가 발생하였습니다.');
                            }
                        }
                    })
                }
            }
            function update(){
                let params = {}
                params.comment = target.comment;
                params.sequenceNo = target.sequenceNo;
                params.suggestionType = target.suggestionType;

                params.contents = $('#popCont').val();
                params.isSecurity = $('#popIsSecurity').is(':checked');
                params.commentSecurity = false

                $.ajax({
                    type: "put", //http method
                    url: "/api/communication/edu-suggestion/update", //값을 가져올 경로
                    headers: {'Content-Type': 'application/json'},
                    data: JSON.stringify(params),
                    dataType: "json",
                    success: function(data) {
                        alert("수정되었습니다.");
                        window.location.reload()
                    },
                    error: function(e) {
                        console.log(e);
                        if(e && e.responseJSON && e.responseJSON.resultMessage){
                            alert(e.responseJSON.resultMessage);
                        }else{
                            alert('교육 제안을 수정하는 과정에서 오류가 발생하였습니다.');
                        }
                    }
                })
            }
            function onLoadSubmit() {
                console.log('commonCode: ', [[ ${commonCode} ]] )
                pagination([[ ${pageable} ]], false)

                let auth = [[ ${#authentication} ]]
                const URL = document.location.href;
                const URLTYPE = URL.split('/')[URL.split('/').length -1];
                const TYPE__ = document.getElementById("type__");

                if(URLTYPE === "journalist"){
                    if(auth.principal.roleGroup!='JOURNALIST'){
                        alert('언론인 권한이 없습니다!');
                        window.location.replace('/communication/edu-suggestion')
                    }
                    TYPE__.innerText = '(언론인)'
                    navigation(3,0,1);
                } else {
                    TYPE__.innerText = '(시민)'
                    navigation(3,0,2);
                }
            }
            /* ]]> */
        </script>
    </th:block>
</div>
</body>
</html>